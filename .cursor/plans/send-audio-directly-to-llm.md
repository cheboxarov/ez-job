# –û—Ç–ø—Ä–∞–≤–∫–∞ –∞—É–¥–∏–æ –Ω–∞–ø—Ä—è–º—É—é –≤ LLM (–±–µ–∑ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏)

## –¶–µ–ª—å

–î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏—é –≤ –æ–∫–Ω–æ Push-to-Talk (Ctrl+Shift+P) –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ–∑–∞–ø–∏—Å–∏ –Ω–∞–ø—Ä—è–º—É—é –≤ LLM, –º–∏–Ω—É—è —ç—Ç–∞–ø —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ —á–µ—Ä–µ–∑ AssemblyAI.

## –¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ PushToTalk –æ–∫–Ω–µ
2. –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∞—É–¥–∏–æ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è (1/3/5 –º–∏–Ω—É—Ç)
3. –ê—É–¥–∏–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é (AssemblyAI)
4. –¢–µ–∫—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ LLM
5. –û—Ç–≤–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è

## –ù–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (—Å –≥–∞–ª–æ—á–∫–æ–π "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é")

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∫–ª—é—á–∞–µ—Ç –≥–∞–ª–æ—á–∫—É "Send recording directly"
2. –ù–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
3. –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∞—É–¥–∏–æ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
4. **–ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é** ‚Üí –∞—É–¥–∏–æ (base64) –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ LLM
5. LLM –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞—É–¥–∏–æ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- –ë—ã—Å—Ç—Ä–µ–µ (–Ω–µ—Ç –∑–∞–¥–µ—Ä–∂–∫–∏ –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é)
- –≠–∫–æ–Ω–æ–º–∏—è –Ω–∞ AssemblyAI API
- LLM –º–æ–∂–µ—Ç "—Å–ª—ã—à–∞—Ç—å" –∏–Ω—Ç–æ–Ω–∞—Ü–∏–∏, –ø–∞—É–∑—ã, –∞–∫—Ü–µ–Ω—Ç—ã
- –†–∞–±–æ—Ç–∞–µ—Ç —Å –º–æ–¥–µ–ª—è–º–∏ GPT-4o, Claude, Gemini (–∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç audio input)

---

## –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. –û–±–Ω–æ–≤–∏—Ç—å —Ç–∏–ø—ã (`src/types/voice.ts`)

```typescript
// –î–æ–±–∞–≤–∏—Ç—å –≤ VoiceTranscriptionConfig
export interface VoiceTranscriptionConfig {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
  sendAudioDirectly: boolean  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é false
}

// –î–æ–±–∞–≤–∏—Ç—å –≤ PushToTalkState
export interface PushToTalkState {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
  sendDirectly: boolean  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –≥–∞–ª–æ—á–∫–∏
}
```

### 2. –û–±–Ω–æ–≤–∏—Ç—å ConfigHelper (`electron/ConfigHelper.ts`)

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `sendAudioDirectly` –≤ `TranscriptionConfig`:

```typescript
export interface TranscriptionConfig {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
  sendAudioDirectly: boolean
}

// –í defaultTranscriptionConfig
const defaultTranscriptionConfig: TranscriptionConfig = {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
  sendAudioDirectly: false
}
```

### 3. –û–±–Ω–æ–≤–∏—Ç—å ProcessingHelper (`electron/ProcessingHelper.ts`)

#### 3.1 –†–∞—Å—à–∏—Ä–∏—Ç—å —Ç–∏–ø OpenAIMessage –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∞—É–¥–∏–æ

```typescript
type OpenAIMessage =
  | {
      role: "system" | "assistant";
      content: string;
    }
  | {
      role: "user";
      content:
        | string
        | Array<
            | { type: "text"; text: string }
            | { type: "image_url"; image_url: { url: string } }
            | { type: "input_audio"; input_audio: { data: string; format: "wav" | "mp3" | "webm" | "ogg" } }
          >;
    };
```

#### 3.2 –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ processVoiceQueryWithAudio

```typescript
public async processVoiceQueryWithAudio(
  audioBase64: string,
  audioFormat: string,
  systemPromptOverride?: string
): Promise<string> {
  const config = configHelper.loadConfig()
  const languageInstruction = this.getResponseLanguageInstruction(
    config.interfaceLanguage
  )

  const promptHeader = systemPromptOverride?.trim()
    ? systemPromptOverride.trim()
    : "You are an interview assistant.\nThe user is in an interview and needs help answering questions."

  const systemPrompt = `${languageInstruction} ${promptHeader}
Listen to the audio recording below. This is a recording from an interview or meeting.
Please provide a helpful response to the questions or topics discussed in the audio.`

  const messages: OpenAIMessage[] = [
    { role: "system", content: systemPrompt },
    {
      role: "user",
      content: [
        {
          type: "text",
          text: "Please listen to this audio and help me with the question or topic being discussed."
        },
        {
          type: "input_audio",
          input_audio: {
            data: audioBase64,
            format: audioFormat as "wav" | "mp3" | "webm" | "ogg"
          }
        }
      ]
    }
  ]

  return this.callLLM(messages, { maxTokens: 1200, temperature: 0.2 })
}
```

### 4. –î–æ–±–∞–≤–∏—Ç—å IPC handler (`electron/ipcHandlers.ts`)

```typescript
ipcMain.handle("voice:process-audio-directly", async (_event, payload) => {
  if (!deps.processingHelper) {
    return { success: false, error: "Processing helper not available." }
  }
  const { audioData, mimeType, systemPrompt } = payload || {}

  if (!audioData) {
    return { success: false, error: "Missing audio data." }
  }

  try {
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º ArrayBuffer –≤ base64
    const buffer = Buffer.from(audioData)
    const audioBase64 = buffer.toString("base64")

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∏–∑ mimeType
    let format = "webm"
    if (mimeType?.includes("wav")) format = "wav"
    else if (mimeType?.includes("mp3")) format = "mp3"
    else if (mimeType?.includes("ogg")) format = "ogg"

    const response = await deps.processingHelper.processVoiceQueryWithAudio(
      audioBase64,
      format,
      systemPrompt
    )
    return { success: true, response }
  } catch (error: any) {
    return {
      success: false,
      error: error?.message || "Failed to process audio directly."
    }
  }
})
```

### 5. –û–±–Ω–æ–≤–∏—Ç—å preload.ts

```typescript
voice: {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã
  processAudioDirectly: (data: {
    audioData: ArrayBuffer;
    mimeType: string;
    systemPrompt?: string;
  }) => ipcRenderer.invoke("voice:process-audio-directly", data)
}
```

### 6. –û–±–Ω–æ–≤–∏—Ç—å —Ç–∏–ø—ã Electron API (`src/types/electron.d.ts`)

```typescript
voice: {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã
  processAudioDirectly: (data: {
    audioData: ArrayBuffer;
    mimeType: string;
    systemPrompt?: string;
  }) => Promise<{ success: boolean; response?: string; error?: string }>;
}
```

### 7. –û–±–Ω–æ–≤–∏—Ç—å VoiceContext (`src/contexts/VoiceContext.tsx`)

–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –º–µ—Ç–æ–¥—ã –¥–ª—è –ø—Ä—è–º–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏:

```typescript
// –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
const [sendDirectly, setSendDirectly] = useState(false)

// –û–±–Ω–æ–≤–∏—Ç—å sendLastMinutes
const sendLastMinutes = useCallback(
  async (minutes: TimeSelection) => {
    if (!continuousRef.current) return null
    const activeConfig = config || (await refreshConfig())
    if (!activeConfig) return null

    setPttState((prev) => ({
      ...prev,
      isProcessing: true,
      stage: "extracting",
      continuousMode: true
    }))
    setError(null)

    try {
      const { blob, mimeType } =
        await continuousRef.current.getLastMinutes(minutes)

      if (!blob || blob.size === 0) {
        setError("Recording buffer is empty.")
        setPttState((prev) => ({
          ...prev,
          isProcessing: false,
          stage: "recording",
          continuousMode: true
        }))
        return null
      }

      const audioBuffer = await blob.arrayBuffer()

      // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –æ–ø—Ü–∏—è "–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é"
      if (sendDirectly) {
        setPttState((prev) => ({
          ...prev,
          stage: "thinking",  // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º "transcribing"
          continuousMode: true
        }))

        const llmResult = await window.electronAPI.voice.processAudioDirectly({
          audioData: audioBuffer,
          mimeType,
          systemPrompt: activeConfig.pttPrompt || undefined
        })

        if (!llmResult?.success) {
          setError(llmResult?.error || "Failed to process audio directly.")
          setPttState((prev) => ({
            ...prev,
            isProcessing: false,
            stage: "recording",
            continuousMode: true
          }))
          return null
        }

        setPttState((prev) => ({
          ...prev,
          isProcessing: false,
          stage: "recording",
          continuousMode: true
        }))

        return {
          transcription: "[Audio sent directly to LLM]",
          response: llmResult.response || ""
        }
      }

      // –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ —Å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–µ–π...
      // ...
    } catch (err) {
      // ...
    }
  },
  [config, refreshConfig, sendDirectly]
)

// –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
return (
  <VoiceContext.Provider
    value={{
      // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
      sendDirectly,
      setSendDirectly
    }}
  >
    {children}
  </VoiceContext.Provider>
)
```

### 8. –û–±–Ω–æ–≤–∏—Ç—å UI PushToTalk (`src/_pages/PushToTalk.tsx`)

–î–æ–±–∞–≤–∏—Ç—å –≥–∞–ª–æ—á–∫—É –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:

```tsx
function PushToTalkContent() {
  const { t } = useTranslation()
  const {
    pttState,
    startContinuousRecording,
    stopContinuousRecording,
    sendLastMinutes,
    bufferDuration,
    error,
    clearError,
    sendDirectly,      // –ù–æ–≤–æ–µ
    setSendDirectly    // –ù–æ–≤–æ–µ
  } = useVoice()

  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥

  return (
    <div className="h-screen w-screen bg-transparent text-white">
      <div className="relative flex h-full w-full flex-col items-center gap-2 rounded-xl border border-white/10 bg-black/70 px-3 py-3 backdrop-blur-sm">
        {/* ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π header */}

        {/* –ù–æ–≤–∞—è –≥–∞–ª–æ—á–∫–∞ */}
        <label
          className="flex items-center gap-2 text-xs text-white/60 cursor-pointer"
          style={noDragStyle}
        >
          <input
            type="checkbox"
            checked={sendDirectly}
            onChange={(e) => setSendDirectly(e.target.checked)}
            className="h-3 w-3 rounded border-white/30 bg-white/10 accent-blue-500"
            disabled={pttState.isProcessing}
          />
          <span>{t("voice.ptt.sendDirectly", "Send audio directly to LLM")}</span>
        </label>

        {/* ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–Ω–æ–ø–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ */}
      </div>
    </div>
  )
}
```

### 9. –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é

**`src/i18n/locales/en.json`:**

```json
{
  "voice": {
    "ptt": {
      "sendDirectly": "Send audio directly to LLM",
      "sendDirectlyHint": "Skip transcription, send audio directly (requires model with audio support)"
    }
  }
}
```

**`src/i18n/locales/ru.json`:**

```json
{
  "voice": {
    "ptt": {
      "sendDirectly": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞—É–¥–∏–æ –Ω–∞–ø—Ä—è–º—É—é –≤ LLM",
      "sendDirectlyHint": "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞—É–¥–∏–æ –Ω–∞–ø—Ä—è–º—É—é (—Ç—Ä–µ–±—É–µ—Ç—Å—è –º–æ–¥–µ–ª—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∞—É–¥–∏–æ)"
    }
  }
}
```

---

## –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **Types** - –æ–±–Ω–æ–≤–∏—Ç—å `src/types/voice.ts` –∏ `src/types/electron.d.ts`
2. **Config** - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –≤ `electron/ConfigHelper.ts`
3. **ProcessingHelper** - –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `processVoiceQueryWithAudio`
4. **IPC handlers** - –¥–æ–±–∞–≤–∏—Ç—å handler `voice:process-audio-directly`
5. **Preload** - –æ–±–Ω–æ–≤–∏—Ç—å `electron/preload.ts`
6. **VoiceContext** - –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ `sendDirectly` –∏ –ª–æ–≥–∏–∫—É
7. **UI** - –¥–æ–±–∞–≤–∏—Ç—å –≥–∞–ª–æ—á–∫—É –≤ `PushToTalk.tsx`
8. **i18n** - –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è

---

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –º–æ–¥–µ–ª–µ–π

–§—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –º–æ–¥–µ–ª—è–º–∏, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º–∏ audio input:
- **OpenAI**: GPT-4o, GPT-4o-mini
- **Anthropic Claude**: Claude 3.5 Sonnet (—á–µ—Ä–µ–∑ API)
- **Google Gemini**: Gemini 1.5 Pro/Flash

–ï—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ, API –≤–µ—Ä–Ω—ë—Ç –æ—à–∏–±–∫—É. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å fallback –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é.

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **Auto-detect model support** - –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É audio input –¥–ª—è —Ç–µ–∫—É—â–µ–π –º–æ–¥–µ–ª–∏
2. **Fallback** - –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é
3. **Settings** - —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ `sendDirectly` –≤ –∫–æ–Ω—Ñ–∏–≥–µ
4. **Visual indicator** - –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–∫–æ–Ω–∫—É üéß –∫–æ–≥–¥–∞ —Ä–µ–∂–∏–º –ø—Ä—è–º–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∫–ª—é—á–µ–Ω
