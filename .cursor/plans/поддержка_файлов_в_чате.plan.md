# План: Добавление поддержки файлов в чате

## Проблема

В чате отображаются только текстовые сообщения. Файлы, прикреплённые к сообщениям (например, тестовые задания от HR), не отображаются и не доступны для скачивания.

## Анализ текущего состояния

### Данные с HH API

Сообщения с файлами содержат поле `files`:

```json
{
  "id": 12750237418,
  "text": "",
  "files": [
    {
      "url": "https://disk.hh.ru/download/redirect?upload_id=e348e506-5709-4907-99dc-627630c0ea36",
      "title": "Тестовое задание Backend python.docx",
      "content_type": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
      "upload_id": "e348e506-5709-4907-99dc-627630c0ea36"
    }
  ]
}
```

### Текущая реализация

- **Бэкенд:** Поле `files` игнорируется при маппинге в `HHChatMessage`
- **Фронтенд:** Сообщения без текста пропускаются (`if (!message.text?.trim()) return null`)
- **Результат:** Сообщения с файлами не отображаются вообще

---

## План реализации

### Шаг 1: Бэкенд — добавить сущность для файла

**Файл:** `backend/domain/entities/hh_chat_file.py` (новый)

```python
from dataclasses import dataclass
from typing import Optional, Dict, Any

@dataclass(slots=True)
class HHChatFile:
    url: str
    title: str
    content_type: str
    upload_id: str
    preview: Optional[Dict[str, Any]] = None
    properties: Optional[Dict[str, Any]] = None
```

### Шаг 2: Бэкенд — обновить HHChatMessage

**Файл:** `backend/domain/entities/hh_chat_message.py`

Добавить поле:

```python
files: Optional[List[HHChatFile]] = None
```

### Шаг 3: Бэкенд — обновить маппинг в HHChatClient

**Файл:** `backend/infrastructure/clients/hh_chat_client.py`

В методе `_map_chat_message()` добавить парсинг поля `files`:

```python
files_raw = raw.get("files", [])
files = None
if files_raw and isinstance(files_raw, list):
    files = [
        HHChatFile(
            url=f.get("url", ""),
            title=f.get("title", ""),
            content_type=f.get("content_type", ""),
            upload_id=f.get("upload_id", ""),
            preview=f.get("preview"),
            properties=f.get("properties"),
        )
        for f in files_raw
        if isinstance(f, dict)
    ]
```

### Шаг 4: Бэкенд — обновить DTO

**Файл:** `backend/presentation/dto/chat_response.py`

Добавить:

```python
class ChatFileResponse(BaseModel):
    url: str
    title: str
    content_type: str
    upload_id: str

class ChatMessageResponse(BaseModel):
    # ... существующие поля
    files: Optional[List[ChatFileResponse]] = None
```

### Шаг 5: Фронтенд — добавить тип для файла

**Файл:** `frontend/src/types/api.ts`

```typescript
export interface ChatFile {
  url: string;
  title: string;
  content_type: string;
  upload_id: string;
}

export interface ChatMessage {
  // ... существующие поля
  files?: ChatFile[] | null;
}
```

### Шаг 6: Фронтенд — создать компонент FileAttachment

**Файл:** `frontend/src/components/FileAttachment.tsx` (новый)

```tsx
import { FileOutlined, DownloadOutlined } from '@ant-design/icons';
import { Button, Typography } from 'antd';
import { ChatFile } from '../types/api';

interface FileAttachmentProps {
  file: ChatFile;
  variant?: 'user' | 'assistant';
}

export const FileAttachment: React.FC<FileAttachmentProps> = ({ file, variant = 'assistant' }) => {
  const isUser = variant === 'user';

  const getFileIcon = (contentType: string) => {
    // Иконка в зависимости от типа файла
    if (contentType.includes('word') || contentType.includes('document')) {
      return <FileWordOutlined />;
    }
    if (contentType.includes('pdf')) {
      return <FilePdfOutlined />;
    }
    // ... другие типы
    return <FileOutlined />;
  };

  return (
    <div style={{
      display: 'flex',
      alignItems: 'center',
      gap: 12,
      padding: '12px 16px',
      borderRadius: 12,
      background: isUser ? 'rgba(255,255,255,0.15)' : '#f5f5f5',
      marginTop: 8,
    }}>
      {getFileIcon(file.content_type)}
      <div style={{ flex: 1, minWidth: 0 }}>
        <Typography.Text
          ellipsis
          style={{
            display: 'block',
            color: isUser ? '#fff' : '#0f172a',
          }}
        >
          {file.title}
        </Typography.Text>
      </div>
      <Button
        type="link"
        icon={<DownloadOutlined />}
        href={file.url}
        target="_blank"
        rel="noopener noreferrer"
        style={{ color: isUser ? '#fff' : undefined }}
      >
        Скачать
      </Button>
    </div>
  );
};
```

### Шаг 7: Фронтенд — обновить ChatDetailPage

**Файл:** `frontend/src/pages/ChatDetailPage.tsx`

1. Убрать условие пропуска пустых сообщений (или изменить логику):
```typescript
// Было:
if (!message.text?.trim()) return null;

// Стало:
const hasContent = message.text?.trim() || (message.files && message.files.length > 0);
if (!hasContent) return null;
```

2. Добавить рендеринг файлов после текста:
```tsx
{/* Текст сообщения */}
{message.text?.trim() && (
  <MarkdownMessage content={message.text} variant={isUser ? 'user' : 'assistant'} />
)}

{/* Прикреплённые файлы */}
{message.files && message.files.length > 0 && (
  <div style={{ marginTop: message.text?.trim() ? 8 : 0 }}>
    {message.files.map((file) => (
      <FileAttachment
        key={file.upload_id}
        file={file}
        variant={isUser ? 'user' : 'assistant'}
      />
    ))}
  </div>
)}
```


---

## Порядок выполнения

1. [ ] Создать `HHChatFile` entity
2. [ ] Обновить `HHChatMessage` — добавить поле `files`
3. [ ] Обновить маппинг в `HHChatClient._map_chat_message()`
4. [ ] Создать `ChatFileResponse` DTO и обновить `ChatMessageResponse`
5. [ ] Обновить типы на фронтенде (`ChatFile`, `ChatMessage`)
6. [ ] Создать компонент `FileAttachment`
7. [ ] Обновить `ChatDetailPage` — добавить рендеринг файлов
8. [ ] Протестировать отображение файлов в чате

---

## Файлы для изменения

### Бэкенд:

- `backend/domain/entities/hh_chat_file.py` — **создать**
- `backend/domain/entities/hh_chat_message.py` — добавить `files`
- `backend/infrastructure/clients/hh_chat_client.py` — парсить `files`
- `backend/presentation/dto/chat_response.py` — добавить `ChatFileResponse`

### Фронтенд:

- `frontend/src/types/api.ts` — добавить `ChatFile`
- `frontend/src/components/FileAttachment.tsx` — **создать**
- `frontend/src/pages/ChatDetailPage.tsx` — рендерить файлы