# Админ-панель

## Обзор

Админ-панель предоставляет администраторам системы (пользователям с флагом `is_superuser = true`) возможность управлять пользователями, тарифными планами, просматривать метрики использования LLM и анализировать вызовы LLM.

## Доступ к админ-панели

Админ-панель доступна по адресу `/admin` и защищена проверкой прав доступа:
- Пользователь должен быть авторизован
- Пользователь должен иметь флаг `is_superuser = true`

При попытке доступа пользователя без прав суперпользователя происходит автоматический редирект на основное приложение.

## Структура админ-панели

Админ-панель состоит из следующих разделов:

### 1. Пользователи (`/admin/users`)

Раздел для управления пользователями системы:
- Просмотр списка всех пользователей с пагинацией
- Поиск пользователей по части номера телефона
- Просмотр детальной информации о пользователе
- Изменение флагов пользователя (`is_active`, `is_verified`)
- Смена тарифного плана пользователя
- Сброс счетчиков и сдвиг дат подписки
- Удаление пользователя с каскадным удалением всех связанных данных

### 2. Планы (`/admin/plans`)

Раздел для управления тарифными планами:
- Просмотр списка всех планов (активных и неактивных)
- Создание новых тарифных планов
- Редактирование существующих планов (название, лимиты, цена, длительность)
- Деактивация планов

### 3. LLM вызовы (`/admin/llm-calls`)

Раздел для просмотра и анализа вызовов LLM:
- Таблица всех вызовов LLM с пагинацией
- Фильтрация по периоду, пользователю, агенту, статусу
- Детальный просмотр каждого вызова:
  - Промпт (полный текст запроса)
  - Ответ LLM
  - Количество токенов (входных и выходных)
  - Время выполнения
  - Модель и параметры (температура и т.д.)
  - Ошибки (если были)

### 4. Метрики (`/admin/metrics`)

Дэшборд с аналитикой использования системы:
- Выбор периода для анализа (начальная и конечная дата)
- Фильтрация по тарифному плану
- Графики метрик:
  - Использование LLM токенов по периодам
  - Количество вызовов LLM
  - Количество откликов по вакансиям
  - Средние значения на пользователя
- Сводные карточки с общими показателями

## Навигация

В левой части экрана находится боковое меню с разделами админ-панели. В верхней части отображается заголовок "Админ-панель" и email текущего администратора.

В нижней части меню находятся кнопки:
- **Вернуться в приложение** — переход в основное приложение
- **Выйти** — выход из системы

## Защита роутов

Все роуты админ-панели (`/admin/*`) защищены компонентом `AdminProtectedRoute`, который:
1. Проверяет наличие токена авторизации
2. Проверяет флаг `is_superuser` у текущего пользователя
3. Выполняет редирект при отсутствии прав доступа

## Технические детали

### Компоненты

- `AdminLayout` — основной layout админ-панели с боковым меню и шапкой
- `AdminProtectedRoute` — компонент защиты роутов для проверки прав суперпользователя
- `AdminUsersPage` — страница управления пользователями
- `AdminPlansPage` — страница управления планами
- `AdminLlmCallsPage` — страница просмотра LLM вызовов
- `AdminMetricsDashboardPage` — страница метрик и аналитики

### Роутинг

Роуты админ-панели определены в `App.tsx`:
- `/admin` — редирект на `/admin/users`
- `/admin/users` — управление пользователями
- `/admin/plans` — управление планами
- `/admin/llm-calls` — просмотр LLM вызовов
- `/admin/metrics` — дэшборд метрик

### Состояние пользователя

Информация о текущем пользователе и его правах хранится в `authStore` (Zustand) и получается из эндпоинта `/users/me`, который возвращает объект пользователя с полем `is_superuser`.

## Функциональность

### Управление пользователями

**Список пользователей** (`/admin/users`):
- Таблица всех пользователей с пагинацией
- Поиск по части номера телефона
- Отображение статусов: активен/неактивен, подтверждён, администратор
- Переход к детальной странице пользователя

**Детальная страница пользователя** (`/admin/users/:id`):
- Основная информация: ID, email, телефон, статусы
- Управление флагами: переключатели для `is_active` и `is_verified`
- Смена тарифного плана: выбор из списка доступных планов
- Удаление пользователя: с подтверждением и каскадным удалением всех данных

### Управление планами

**Страница планов** (`/admin/plans`):
- Таблица всех тарифных планов (активных и неактивных)
- Создание нового плана через модальное окно
- Редактирование существующих планов
- Деактивация планов
- Отображение параметров: лимиты, период сброса, длительность, цена

### LLM вызовы

**Страница LLM вызовов** (`/admin/llm-calls`):
- Таблица всех вызовов LLM с пагинацией
- Фильтры:
  - Период (начальная и конечная дата)
  - ID пользователя
  - Агент
  - Статус (успех/ошибка)
- Детальный просмотр вызова:
  - Полная информация о вызове
  - Промпт (JSON формат)
  - Ответ LLM
  - Метрики: токены, длительность, ошибки

### Метрики

**Дэшборд метрик** (`/admin/metrics`):
- Выбор периода анализа
- Фильтрация по тарифному плану
- Выбор шага группировки (день/неделя/месяц)
- Сводные карточки:
  - Всего вызовов LLM
  - Всего токенов
  - Средние токены на пользователя
  - Уникальных пользователей
  - Всего откликов
  - Средние отклики на пользователя
- Графики:
  - Вызовы LLM по периодам (столбчатая диаграмма)
  - Токены LLM по периодам (линейный график)
  - Отклики по периодам (столбчатая диаграмма)

## UX особенности

- **Обработка ошибок**: Все ошибки API отображаются через уведомления Ant Design
- **Индикаторы загрузки**: Spinner'ы при загрузке данных
- **Подтверждения**: Модальные окна для опасных действий (удаление пользователя)
- **Валидация форм**: Проверка обязательных полей перед отправкой
- **Автоматическое обновление**: Данные обновляются после успешных операций
