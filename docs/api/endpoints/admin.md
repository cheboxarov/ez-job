# Admin API

## Обзор

Админские эндпоинты доступны только пользователям с флагом `is_superuser = true` и находятся под префиксом `/api/admin`.

Все хендлеры в этих роутерах используют зависимость `admin_only`, которая проверяет права администратора на основе текущего авторизованного пользователя.

## Авторизация

- Требуется обычный JWT токен, полученный через `/auth/login`
- Дополнительно на backend используется зависимость `admin_only`, реализованная в `presentation/dependencies.py`

Пример использования зависимости:

- В `admin_router`:
  - `dependencies=[Depends(admin_only)]` гарантирует, что все эндпоинты доступны только суперюзерам

## Базовые эндпоинты

### `GET /api/admin/health`

- Описание: Базовая проверка доступности админского API
- Ответ:
  - `200 OK`:
    - Тело: `{ "status": "ok" }`

## Метрики

### `GET /api/admin/metrics/llm`

Получить метрики использования LLM за период.

**Query параметры:**
- `start_date` (обязательный): Начальная дата (включительно), формат ISO 8601
- `end_date` (обязательный): Конечная дата (включительно), формат ISO 8601
- `plan_id` (опционально): UUID плана подписки для фильтрации
- `time_step` (опционально): Шаг группировки (`day`, `week`, `month`), по умолчанию `day`

**Ответ:**
- `200 OK`: `LlmUsageMetricsResponse`
  - `metrics_by_period`: список метрик по периодам (дата, вызовы, токены, пользователи)
  - `total_metrics`: суммарные метрики (вызовы, токены, пользователи, средние токены на пользователя)

### `GET /api/admin/metrics/responses`

Получить метрики откликов на вакансии за период.

**Query параметры:**
- `start_date` (обязательный): Начальная дата (включительно), формат ISO 8601
- `end_date` (обязательный): Конечная дата (включительно), формат ISO 8601
- `plan_id` (опционально): UUID плана подписки для фильтрации
- `time_step` (опционально): Шаг группировки (`day`, `week`, `month`), по умолчанию `day`

**Ответ:**
- `200 OK`: `VacancyResponsesMetricsResponse`
  - `metrics_by_period`: список метрик по периодам (дата, отклики, пользователи)
  - `total_metrics`: суммарные метрики (отклики, пользователи, средние отклики на пользователя)

### `GET /api/admin/metrics`

Получить комбинированные метрики LLM и откликов за период.

**Query параметры:**
- `start_date` (обязательный): Начальная дата (включительно), формат ISO 8601
- `end_date` (обязательный): Конечная дата (включительно), формат ISO 8601
- `plan_id` (опционально): UUID плана подписки для фильтрации
- `time_step` (опционально): Шаг группировки (`day`, `week`, `month`), по умолчанию `day`

**Ответ:**
- `200 OK`: `CombinedMetricsResponse`
  - `llm_metrics`: метрики LLM (см. `GET /api/admin/metrics/llm`)
  - `responses_metrics`: метрики откликов (см. `GET /api/admin/metrics/responses`)

## LLM вызовы

### `GET /api/admin/llm-calls`

Получить список вызовов LLM для админки с фильтрами и пагинацией.

**Query параметры:**
- `start_date` (опционально): Начальная дата фильтра (включительно), формат ISO 8601
- `end_date` (опционально): Конечная дата фильтра (включительно), формат ISO 8601
- `user_id` (опционально): UUID пользователя для фильтрации
- `agent_name` (опционально): Имя агента для фильтрации
- `status` (опционально): Статус вызова (`success` или `error`)
- `page` (опционально): Номер страницы (начиная с 1), по умолчанию 1
- `page_size` (опционально): Размер страницы (1-200), по умолчанию 20

**Ответ:**
- `200 OK`: `LlmCallListResponse`
  - `items`: список вызовов LLM
  - `total`: общее количество записей
  - `page`: текущая страница
  - `page_size`: размер страницы

### `GET /api/admin/llm-calls/{call_id}`

Получить детальную информацию о конкретном вызове LLM.

**Path параметры:**
- `call_id`: UUID записи о вызове LLM

**Ответ:**
- `200 OK`: `LlmCallResponse` с полной информацией о вызове (промпт, ответ, метрики, ошибки)
- `404 Not Found`: если вызов не найден

