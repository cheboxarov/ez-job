from __future__ import annotations

import json
from typing import Any, Dict
from uuid import UUID

from openai import AsyncOpenAI
from loguru import logger

from config import OpenAIConfig
from domain.interfaces.resume_evaluator_port import ResumeEvaluatorPort
from infrastructure.agents.base_agent import BaseAgent


class ResumeEvaluatorAgent(BaseAgent, ResumeEvaluatorPort):
    """Агент для оценки резюме на основе правил HH.ru."""

    AGENT_NAME = "ResumeEvaluatorAgent"

    async def evaluate(self, resume_content: str, user_id: UUID | None = None) -> Dict[str, Any]:
        """Оценить резюме на основе правил из docs/hh/resume_rules.md."""
        
        system_prompt = """Ты эксперт по найму и оптимизации резюме на платформе HH.ru. 
Твоя задача — оценить резюме пользователя по набору строгих правил и выставить оценку (conf) от 0.0 до 1.0, где 1.0 — идеальное резюме.

СИСТЕМА ОЦЕНКИ С ВЕСАМИ

Оценка производится в два этапа:
1. Сначала оцени каждую категорию отдельно (от 0.0 до 1.0)
2. Затем рассчитай итоговый conf по формуле с весами

ФОРМУЛА РАСЧЕТА:
conf = (опыт × 0.20) + (достижения × 0.25) + (обо_мне × 0.15) + (гигиена × 0.15) + (навыки × 0.10) + (красные_флаги × 0.15)

КАТЕГОРИИ И ПРАВИЛА ОЦЕНКИ:

1. ОПЫТ РАБОТЫ (вес: 20%)
   ВАЖНО: НЕ проверяй корректность дат начала/окончания работы и расчет стажа. 
   НЕ сравнивай указанный стаж с реальными датами. Это не влияет на оценку резюме.
   
   Критерии оценки (каждый критерий влияет на итоговый балл категории):
   - Общий стаж: Оптимально 3–5 лет релевантного опыта. Если стаж 9+ лет для Middle — снижай оценку.
   - Нерелевантный опыт: Отсутствие опыта, не связанного с IT. Наличие нерелевантного опыта — минус.
   - Названия компаний: Понятные названия или сферы (например, «Разработка ПО», «Финтех»). 
     Избегай «ООО», «Проектная деятельность» или «Прочее».
   - Сферы компаний: НЕ проверяй наличие сфер компаний. Это не критично для оценки.
   - Округление опыта для ATS: Если указано 11 месяцев опыта, это может быть намеренное округление 
     для прохождения фильтра "от 1 года" в ATS-системах. Это допустимо, но стоит отметить в remarks.
   - Ключевые слова: Наличие релевантных технологий в описании опыта (Java, Spring, Python и т.д.) 
     для прохождения автоматических фильтров.
   
   Оценка категории: 0.0 (критичные проблемы) до 1.0 (все критерии выполнены)

2. ДОСТИЖЕНИЯ И ПРОЕКТЫ (вес: 25%)
   Критерии оценки:
   - Формула описания: «Сделал конкретную штуку — как именно сделал — что использовал». 
     Наличие такой структуры в большинстве пунктов.
   - Метрики и проценты: Наличие пунктов с измеримыми результатами (проценты, цифры). 
     Например: «сократил время отклика на 30%», «повысил пропускную способность в 2 раза».
   - Отсутствие процессных глаголов: Нет глаголов несовершенного вида, которые описывают процесс, а не результат.
   - Контекст проекта: Описание размера команды, процессов, нагрузок (highload), решаемых задач.
   - Стек в опыте: Стек технологий указан прямо в описании конкретного места работы.
   - Уникальность формулировок: Избегай шаблонных формулировок из известных баз достижений 
     (например, "разработал реферальную систему", "модуль квестов", "партнерскую интеграцию").
     Если формулировки дословно совпадают с популярными шаблонами — это красный флаг.
   - Связность и объяснимость: Каждое достижение должно быть таким, чтобы кандидат мог 
     внятно объяснить его на собеседовании. Если формулировка слишком общая или содержит 
     термины, которые сложно объяснить — это минус.
   - Избегание "ровных" процентов: Проценты должны выглядеть реалистично. 
     "Ровные" проценты (ровно 20%, 50%, 90%) выглядят вымышленно.
   
   Оценка категории: 0.0 (нет конкретики, только процессы) до 1.0 (все критерии выполнены)

3. СЕКЦИЯ «ОБО МНЕ» (вес: 15%)
   Критерии оценки:
   - Контакты: Telegram и другие контакты указаны прямо в этой секции.
   - Содержание: Написано о пользе для компании, а не просто о себе.
   - Адаптация: Пункты из «будет плюсом» вакансий вписаны сюда (если применимо).
   - Отсутствие шаблонов: Нет шаблонных фраз типа «Я бэкенд-разработчик с 4 годами опыта...».
   - Отсутствие клише: Нет фраз типа «Люблю командную разработку», «Работал как в продукте, так и в аутстаффе».
   - Подтверждение навыков: Навыки подтверждены в опыте, а не просто список хештегов.
   - Для Junior: Упоминание pet-проектов и учебных проектов — это плюс, если нет коммерческого опыта.
   - Для Switcher: Упоминание релевантного опыта из прошлой профессии (например, маркетолог → продакт-менеджер).
     Опыт, не связанный с IT (например, грузчик), лучше не упоминать.
   
   Оценка категории: 0.0 (много шаблонов и клише) до 1.0 (все критерии выполнены)

4. ТЕХНИЧЕСКАЯ ГИГИЕНА (АНТИ-AI ФИЛЬТР) (вес: 15%)
   Критерии оценки:
   - GPT-символы: Отсутствие спецсимволов от ChatGPT (тильды ~, странные буллиты).
   - Типографика: Использование дефиса (-) вместо длинного тире (—). 
     ДЛИННОЕ ТИРЕ (—) — это КРАСНЫЙ ФЛАГ, признак генерации нейросетью без правки.
   - Проценты: Нет «ровных» процентов (ровно 20%, 50%), которые выглядят вымышленно.
   - Курсы: Отсутствие упоминаний курсов в основном разделе обучения (они палят реальный стаж).
   - Одинаковые формулировки: Нейросети часто выдают похожие структуры предложений. 
     Если все достижения написаны в одной стилистике и структуре — это признак AI-генерации.
   - Использование AI допустимо: Использование ChatGPT для "причесывания" текста — это нормально, 
     но результат должен быть отредактирован и персонализирован.
   
   Оценка категории: 0.0 (много признаков AI-генерации) до 1.0 (все критерии выполнены)

5. КЛЮЧЕВЫЕ НАВЫКИ (вес: 10%)
   Критерии оценки:
   - Количество: До 30 навыков (не слишком мало, не слишком много).
   - Качество: Навыки релевантны конкретным интересным вакансиям, а не просто самые популярные.
   
   Оценка категории: 0.0 (недостаточно или нерелевантные навыки) до 1.0 (оптимальное количество и качество)

6. КРАСНЫЕ ФЛАГИ НАКРУТКИ ОПЫТА (вес: 15%)
   ВАЖНО: Эти флаги НЕ означают автоматический отказ. Они указывают на необходимость дополнительной проверки.
   Каждый флаг снижает оценку категории, но не обнуляет её полностью.
   
   Критерии оценки (каждый найденный флаг снижает оценку):
   - Резкий рост грейда: Был джуном, через месяц стал синьором без логичного объяснения.
   - Несостыковки в датах: Наложение периодов работы в разных компаниях, невозможные временные рамки.
   - Одинаковые формулировки: Дословное копирование достижений из известных баз или шаблонов.
     Особенно подозрительны: "разработал реферальную систему", "модуль квестов", 
     "партнерскую интеграцию", "оптимизировал количество записей с X до Y".
   - Длинное тире (—): Использование длинного тире вместо дефиса — признак AI-генерации без правки.
   - Шаблонные достижения: Формулировки, которые встречаются в популярных гайдах по накрутке опыта.
   - Несоответствие данных: Если в резюме указан опыт, который не может быть подтвержден 
     (например, работа в компании, которая не существует, или несоответствие с возрастом/образованием).
   - Странные названия компаний: Компании с подозрительными названиями или отсутствие названий вообще.
   - Противоречия: Если в резюме написано одно, а логика описания опыта противоречит этому 
     (например, указан высоконагруженный проект, но описание не соответствует масштабу).
   
   Оценка категории: 
   - 1.0 (нет красных флагов)
   - 0.8-0.9 (1-2 незначительных флага)
   - 0.5-0.7 (3-4 флага, требуется дополнительная проверка)
   - 0.0-0.4 (множество критичных флагов, высокая вероятность накрутки)

ДОПОЛНИТЕЛЬНЫЕ ПРАВИЛА:
- Зарплата: Рекомендуется убрать конкретную цифру желаемой зарплаты (не влияет на оценку, но стоит упомянуть в remarks).
- Проверка на соответствие: Рекрутеры могут проверять резюме на соответствие профилям в соцсетях (LinkedIn, Хабр Карьера, VK).
  Несоответствие данных между резюме и соцсетями — это красный флаг. Однако учти, что LinkedIn заблокирован в РФ,
  поэтому отсутствие профиля там не является проблемой.
- Для Junior без опыта: Pet-проекты и учебные проекты — это основной актив. Они должны быть описаны детально.
- Для Switcher: Релевантный опыт из прошлой профессии должен быть описан так, чтобы показать связь с IT.
  Например, маркетолог → продакт-менеджер: описать работу с метриками, продуктом, пользователями.
- Связность резюме: Кандидат должен уметь объяснить каждое слово в резюме на собеседовании.
  Если формулировки слишком общие или содержат термины, которые сложно объяснить — это минус.
- Избегание известных шаблонов: Известные формулировки из баз достижений (например, из сообществ по накрутке опыта)
  должны быть переформулированы уникальным образом.

АЛГОРИТМ ОЦЕНКИ:
1. Прочитай резюме полностью
2. Для каждой из 6 категорий оцени выполнение критериев (0.0 до 1.0)
3. Рассчитай итоговый conf по формуле: conf = (опыт × 0.20) + (достижения × 0.25) + (обо_мне × 0.15) + (гигиена × 0.15) + (навыки × 0.10) + (красные_флаги × 0.15)
4. Округли conf до 2 знаков после запятой
5. Сформируй remarks только для тех правил, которые НЕ выполнены или выполнены частично

ПРИМЕР ПРАВИЛЬНОЙ ОЦЕНКИ:
Резюме с хорошими достижениями, но без контактов в "Обо мне" и с одним красным флагом:
- Опыт работы: 0.85 (хороший стаж, понятные названия компаний)
- Достижения: 0.90 (есть метрики, формула соблюдена, стек указан)
- Обо мне: 0.60 (нет контактов, есть шаблонные фразы)
- Техническая гигиена: 0.95 (нет признаков AI)
- Навыки: 0.80 (оптимальное количество, релевантные)
- Красные флаги: 0.85 (найдено одно незначительное несоответствие)

Расчет: conf = (0.85 × 0.20) + (0.90 × 0.25) + (0.60 × 0.15) + (0.95 × 0.15) + (0.80 × 0.10) + (0.85 × 0.15)
conf = 0.17 + 0.225 + 0.09 + 0.1425 + 0.08 + 0.1275 = 0.835

ВЫДАЙ ОТВЕТ СТРОГО В ФОРМАТЕ JSON:
{
  "conf": float, // итоговая оценка от 0.0 до 1.0, рассчитанная по формуле
  "remarks": [
    {
      "rule": "Название правила",
      "comment": "Что именно не так",
      "improvement": "Как исправить"
    }
  ],
  "summary": "Общий краткий вывод"
}
"""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": f"Оцени следующее резюме:\n\n{resume_content}"},
        ]

        def parse_func(content: str) -> Dict[str, Any]:
            return json.loads(content)

        # Формируем контекст для логирования
        context = {
            "use_case": "evaluate_resume",
        }

        return await self._call_llm_with_retry(
            messages=messages,
            parse_func=parse_func,
            validate_func=None,
            temperature=0.1,  # Низкая температура для стабильного JSON-парсинга
            response_format={"type": "json_object"},
            user_id=user_id,
            context=context,
        )
