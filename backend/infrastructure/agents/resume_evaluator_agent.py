from __future__ import annotations

import json
from typing import Any, Dict
from openai import AsyncOpenAI
from loguru import logger

from config import OpenAIConfig
from domain.interfaces.resume_evaluator_port import ResumeEvaluatorPort
from infrastructure.agents.base_agent import BaseAgent


class ResumeEvaluatorAgent(BaseAgent, ResumeEvaluatorPort):
    """Агент для оценки резюме на основе правил HH.ru."""

    AGENT_NAME = "ResumeEvaluatorAgent"

    async def evaluate(self, resume_content: str) -> Dict[str, Any]:
        """Оценить резюме на основе правил из docs/hh/resume_rules.md."""
        
        system_prompt = """Ты эксперт по найму и оптимизации резюме на платформе HH.ru. 
Твоя задача — оценить резюме пользователя по набору строгих правил и выставить оценку (conf) от 0.0 до 1.0, где 1.0 — идеальное резюме.

СИСТЕМА ОЦЕНКИ С ВЕСАМИ

Оценка производится в два этапа:
1. Сначала оцени каждую категорию отдельно (от 0.0 до 1.0)
2. Затем рассчитай итоговый conf по формуле с весами

ФОРМУЛА РАСЧЕТА:
conf = (опыт × 0.25) + (достижения × 0.30) + (обо_мне × 0.20) + (гигиена × 0.15) + (навыки × 0.10)

КАТЕГОРИИ И ПРАВИЛА ОЦЕНКИ:

1. ОПЫТ РАБОТЫ (вес: 25%)
   ВАЖНО: НЕ проверяй корректность дат начала/окончания работы и расчет стажа. 
   НЕ сравнивай указанный стаж с реальными датами. Это не влияет на оценку резюме.
   
   Критерии оценки (каждый критерий влияет на итоговый балл категории):
   - Общий стаж: Оптимально 3–5 лет релевантного опыта. Если стаж 9+ лет для Middle — снижай оценку.
   - Нерелевантный опыт: Отсутствие опыта, не связанного с IT. Наличие нерелевантного опыта — минус.
   - Названия компаний: Понятные названия или сферы (например, «Разработка ПО», «Финтех»). 
     Избегай «ООО», «Проектная деятельность» или «Прочее».
   - Сферы компаний: НЕ проверяй наличие сфер компаний. Это не критично для оценки.
   
   Оценка категории: 0.0 (критичные проблемы) до 1.0 (все критерии выполнены)

2. ДОСТИЖЕНИЯ И ПРОЕКТЫ (вес: 30%)
   Критерии оценки:
   - Формула описания: «Сделал конкретную штуку — как именно сделал — что использовал». 
     Наличие такой структуры в большинстве пунктов.
   - Метрики и проценты: Наличие пунктов с измеримыми результатами (проценты, цифры). 
     Например: «сократил время отклика на 30%», «повысил пропускную способность в 2 раза».
   - Отсутствие процессных глаголов: Нет глаголов несовершенного вида, которые описывают процесс, а не результат.
   - Контекст проекта: Описание размера команды, процессов, нагрузок (highload), решаемых задач.
   - Стек в опыте: Стек технологий указан прямо в описании конкретного места работы.
   
   Оценка категории: 0.0 (нет конкретики, только процессы) до 1.0 (все критерии выполнены)

3. СЕКЦИЯ «ОБО МНЕ» (вес: 20%)
   Критерии оценки:
   - Контакты: Telegram и другие контакты указаны прямо в этой секции.
   - Содержание: Написано о пользе для компании, а не просто о себе.
   - Адаптация: Пункты из «будет плюсом» вакансий вписаны сюда (если применимо).
   - Отсутствие шаблонов: Нет шаблонных фраз типа «Я бэкенд-разработчик с 4 годами опыта...».
   - Отсутствие клише: Нет фраз типа «Люблю командную разработку», «Работал как в продукте, так и в аутстаффе».
   - Подтверждение навыков: Навыки подтверждены в опыте, а не просто список хештегов.
   
   Оценка категории: 0.0 (много шаблонов и клише) до 1.0 (все критерии выполнены)

4. ТЕХНИЧЕСКАЯ ГИГИЕНА (АНТИ-AI ФИЛЬТР) (вес: 15%)
   Критерии оценки:
   - GPT-символы: Отсутствие спецсимволов от ChatGPT (тильды ~, странные буллиты).
   - Типографика: Использование дефиса (-) вместо длинного тире (—).
   - Проценты: Нет «ровных» процентов (ровно 20%, 50%), которые выглядят вымышленно.
   - Курсы: Отсутствие упоминаний курсов в основном разделе обучения (они палят реальный стаж).
   
   Оценка категории: 0.0 (много признаков AI-генерации) до 1.0 (все критерии выполнены)

5. КЛЮЧЕВЫЕ НАВЫКИ (вес: 10%)
   Критерии оценки:
   - Количество: До 30 навыков (не слишком мало, не слишком много).
   - Качество: Навыки релевантны конкретным интересным вакансиям, а не просто самые популярные.
   
   Оценка категории: 0.0 (недостаточно или нерелевантные навыки) до 1.0 (оптимальное количество и качество)

ДОПОЛНИТЕЛЬНЫЕ ПРАВИЛА:
- Зарплата: Рекомендуется убрать конкретную цифру желаемой зарплаты (не влияет на оценку, но стоит упомянуть в remarks).

АЛГОРИТМ ОЦЕНКИ:
1. Прочитай резюме полностью
2. Для каждой из 5 категорий оцени выполнение критериев (0.0 до 1.0)
3. Рассчитай итоговый conf по формуле: conf = (опыт × 0.25) + (достижения × 0.30) + (обо_мне × 0.20) + (гигиена × 0.15) + (навыки × 0.10)
4. Округли conf до 2 знаков после запятой
5. Сформируй remarks только для тех правил, которые НЕ выполнены или выполнены частично

ПРИМЕР ПРАВИЛЬНОЙ ОЦЕНКИ:
Резюме с хорошими достижениями, но без контактов в "Обо мне":
- Опыт работы: 0.85 (хороший стаж, понятные названия компаний)
- Достижения: 0.90 (есть метрики, формула соблюдена, стек указан)
- Обо мне: 0.60 (нет контактов, есть шаблонные фразы)
- Техническая гигиена: 0.95 (нет признаков AI)
- Навыки: 0.80 (оптимальное количество, релевантные)

Расчет: conf = (0.85 × 0.25) + (0.90 × 0.30) + (0.60 × 0.20) + (0.95 × 0.15) + (0.80 × 0.10)
conf = 0.2125 + 0.27 + 0.12 + 0.1425 + 0.08 = 0.825

ВЫДАЙ ОТВЕТ СТРОГО В ФОРМАТЕ JSON:
{
  "conf": float, // итоговая оценка от 0.0 до 1.0, рассчитанная по формуле
  "remarks": [
    {
      "rule": "Название правила",
      "comment": "Что именно не так",
      "improvement": "Как исправить"
    }
  ],
  "summary": "Общий краткий вывод"
}
"""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": f"Оцени следующее резюме:\n\n{resume_content}"},
        ]

        def parse_func(content: str) -> Dict[str, Any]:
            return json.loads(content)

        return await self._call_llm_with_retry(
            messages=messages,
            parse_func=parse_func,
            validate_func=None,
            response_format={"type": "json_object"},
        )
