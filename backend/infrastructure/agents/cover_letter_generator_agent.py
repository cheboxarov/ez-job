"""Агент для генерации сопроводительных писем на основе текстового описания вакансии."""

from __future__ import annotations

import re
from uuid import UUID

from openai import AsyncOpenAI
from loguru import logger

from config import OpenAIConfig
from domain.interfaces.cover_letter_generator_port import CoverLetterGeneratorPort
from infrastructure.agents.base_agent import BaseAgent


class CoverLetterGeneratorAgent(BaseAgent, CoverLetterGeneratorPort):
    """LLM‑агент для генерации сопроводительного письма к вакансии.

    Работает с текстовым описанием вакансии (для list-вакансий),
    в отличие от CoverLetterAgent, который работает с FilteredVacancyDetail.
    """

    AGENT_NAME = "CoverLetterGeneratorAgent"

    async def generate(
        self,
        resume: str,
        vacancy_description: str,
        user_params: str | None = None,
        user_id: UUID | None = None,
    ) -> str:
        """Сгенерировать сопроводительное письмо для вакансии.

        Args:
            resume: Текст резюме кандидата.
            vacancy_description: Описание вакансии (название, требования, обязанности).
            user_params: Дополнительные требования/предпочтения пользователя (опционально).

        Returns:
            Текст сопроводительного письма на русском языке.
        """
        if not resume or not vacancy_description:
            return ""

        prompt = self._build_prompt(resume, vacancy_description, user_params)
        logger.info(
            f"[{self.AGENT_NAME}] генерирую сопроводительное письмо model={self._config.model}"
        )

        messages = [
            {
                "role": "system",
                "content": """Ты профессиональный HR-консультант, специализирующийся на написании кратких и убедительных сопроводительных писем.

Твоя задача — написать КОРОТКОЕ (100-150 слов) персонализированное сопроводительное письмо на русском языке.

СТРУКТУРА (все в одном абзаце):
1. Краткое приветствие с упоминанием вакансии
2. Перечисление ключевых технологий и навыков из вакансии, которыми кандидат ОБЛАДАЕТ (ОБЯЗАТЕЛЬНО!)
3. Краткое описание релевантных навыков и опыта (БЕЗ упоминания названий компаний!)
4. Краткое выражение желания работать в компании

КРИТИЧЕСКИ ВАЖНО:

1. АНАЛИЗ ВАКАНСИИ И СООТВЕТСТВИЕ СТЕКУ:
   - Внимательно проанализируй требования вакансии (технологии, навыки, инструменты)
   - ОБЯЗАТЕЛЬНО перечисли 3-5 конкретных технологий/навыков из вакансии: "Обладаю навыками работы с вашим стеком: Python, FastAPI, PostgreSQL, Redis"
   - ПИШИ, ЧТО ОБЛАДАЕШЬ ЭТИМИ НАВЫКАМИ, ДАЖЕ ЕСЛИ В РЕЗЮМЕ ОНИ НЕ УКАЗАНЫ ЯВНО
   - Используй формулировки: "Работал с...", "Обладаю опытом...", "Имею навыки...", "Владею..."

2. ЗАПРЕТ НА УПОМИНАНИЕ КОМПАНИЙ:
   - НИКОГДА не упоминай названия компаний, в которых работал кандидат
   - НЕ пиши "Работал в компании X", "В компании Y разрабатывал..."
   - Вместо этого пиши о навыках и технологиях: "Разрабатывал микросервисы на Python", "Работал с распределенными системами"

3. ФОКУС НА НАВЫКАХ И ТЕХНОЛОГИЯХ:
   - Подчеркивай соответствие навыков кандидата требованиям вакансии
   - Упоминай конкретные технологии из вакансии, даже если в резюме они не указаны явно
   - Показывай, что кандидат обладает нужными компетенциями

4. КРАТКОСТЬ И КОНКРЕТНОСТЬ:
   - Один абзац, без лишних слов
   - Конкретные технологии и навыки, без общих фраз
   - Уверенный тон, без неуверенности

Пример хорошего письма:
"Добрый день! Откликаюсь на вакансию Python-разработчика. Обладаю навыками работы с вашим стеком: Python, FastAPI, PostgreSQL, Redis - это именно те технологии, с которыми я работаю ежедневно. Имею опыт разработки микросервисной архитектуры для real-time приложений, работы с WebRTC и асинхронными системами. Мой опыт полностью соответствует требованиям вакансии. Очень хочу работать в вашей компании и готов быстро влиться в команду."

Важно:
- Длина: 100-150 слов (один абзац)
- Конкретные технологии из вакансии (даже если их нет в резюме)
- БЕЗ упоминания названий компаний
- Фокус на навыках и технологиях
- Уверенный тон

ФОРМАТ ТИПОГРАФИКИ:
- НЕ используй длинное тире (символ '—') ни в одном месте текста.
- Если нужно тире, используй только обычный дефис '-'.

Верни ТОЛЬКО текст письма, без markdown-разметки, без заголовков, без подписей. Начни сразу с обращения.""",
            },
            {
                "role": "user",
                "content": prompt,
            },
        ]

        def parse_func(content: str) -> str:
            # Очищаем возможные markdown-артефакты
            cover_letter = content.strip()
            # Убираем markdown-код блоки, если они есть
            if cover_letter.startswith("```"):
                lines = cover_letter.split("\n")
                # Пропускаем первую строку (```) и последнюю (```)
                cover_letter = "\n".join(lines[1:-1]).strip()
            return cover_letter

        def validate_func(result: str) -> bool:
            return not result

        # Формируем контекст для логирования
        context = {
            "use_case": "generate_cover_letter",
        }

        return await self._call_llm_with_retry(
            messages=messages,
            parse_func=parse_func,
            validate_func=validate_func,
            temperature=0.5,  # Повышенная температура для большего разнообразия писем
            user_id=user_id,
            context=context,
        )

    def _build_prompt(
        self,
        resume: str,
        vacancy_description: str,
        user_params: str | None = None,
    ) -> str:
        """Формирует текстовый промпт с информацией о вакансии и резюме."""

        lines: list[str] = []
        lines.append("РЕЗЮМЕ КАНДИДАТА:")
        lines.append(resume.strip())
        lines.append("")
        lines.append("ВАКАНСИЯ:")
        lines.append(vacancy_description.strip())
        lines.append("")
        
        # Добавляем дополнительные требования пользователя, если есть
        if user_params and user_params.strip():
            lines.append("ДОПОЛНИТЕЛЬНЫЕ ТРЕБОВАНИЯ/ПРЕДПОЧТЕНИЯ:")
            lines.append(user_params.strip())
            lines.append("")
            lines.append(
                "Учитывай эти требования при генерации письма. "
                "Если они релевантны, можно кратко упомянуть их в письме."
            )
            lines.append("")
        lines.append(
            "Напиши КОРОТКОЕ сопроводительное письмо (100-150 слов, один абзац) для этой вакансии. "
            "ОБЯЗАТЕЛЬНО:"
        )
        lines.append(
            "1. Внимательно проанализируй требования вакансии (технологии, навыки, инструменты)"
        )
        lines.append(
            "2. Перечисли 3-5 конкретных технологий/навыков из вакансии, которыми кандидат ОБЛАДАЕТ "
            "(формат: 'Обладаю навыками работы с вашим стеком: Python, FastAPI, PostgreSQL')"
        )
        lines.append(
            "3. ПИШИ, ЧТО КАНДИДАТ ОБЛАДАЕТ ЭТИМИ НАВЫКАМИ, ДАЖЕ ЕСЛИ В РЕЗЮМЕ ОНИ НЕ УКАЗАНЫ ЯВНО"
        )
        lines.append(
            "4. НИКОГДА не упоминай названия компаний, в которых работал кандидат"
        )
        lines.append(
            "5. Фокусируйся на навыках и технологиях, а не на местах работы"
        )
        lines.append(
            "6. Кратко вырази желание работать ('Очень хочу работать в вашей компании')"
        )
        lines.append(
            "7. Письмо должно быть одним абзацем, без лишних слов, убедительным и конкретным"
        )

        return "\n".join(lines)
